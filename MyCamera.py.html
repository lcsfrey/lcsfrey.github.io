<html>
<head>
<title>MyCamera.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(204,120,50); font-weight: bold; }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(128,128,128); }
.s3 { color: rgb(204,120,50); }
.s4 { color: rgb(104,151,187); }
.s5 { color: rgb(0,128,128); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
MyCamera.py</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">import </span><span class="s1">cv2 
</span><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np 
</span><span class="s0">import </span><span class="s1">time 
 
 
</span><span class="s2"># Needed to initialize trackbars</span><span class="s1"> 
</span><span class="s0">def </span><span class="s1">nothing(x): 
    x = x 
    </span><span class="s0">return </span><span class="s1">x 
 
 
</span><span class="s2"># Webcam object used to interact with frames</span><span class="s1"> 
</span><span class="s0">class </span><span class="s1">MyCamera: 
 
    </span><span class="s2"># Initializes camera and Mats</span><span class="s1"> 
    </span><span class="s0">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">camera_number</span><span class="s3">, </span><span class="s1">output_file): 
        self.outfilename = output_file 
        self.cap = cv2.VideoCapture(camera_number) 
        ret</span><span class="s3">, </span><span class="s1">self.frame1 = self.cap.read() 
        ret</span><span class="s3">, </span><span class="s1">self.frame2 = self.cap.read() 
        ret</span><span class="s3">, </span><span class="s1">self.frame3 = self.cap.read() 
        ret</span><span class="s3">, </span><span class="s1">self.frame4 = self.cap.read() 
        self.frame_count = </span><span class="s4">0</span><span class="s1"> 
        self.grey = self.frame1.copy() 
        self.cannyMin = </span><span class="s4">80</span><span class="s1"> 
        self.cannyMax = </span><span class="s4">255</span><span class="s1"> 
        self.threshMin = </span><span class="s4">100</span><span class="s1"> 
        self.threshMax = </span><span class="s4">255</span><span class="s1"> 
        self.minPixels = </span><span class="s4">1000</span><span class="s1"> 
 
        </span><span class="s2"># Create a black image, a window</span><span class="s1"> 
        img = np.zeros((</span><span class="s4">300</span><span class="s3">, </span><span class="s4">512</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.uint8) 
        cv2.namedWindow(</span><span class="s5">'image'</span><span class="s1">) 
        </span><span class="s2"># create trackbars for thresholds</span><span class="s1"> 
        cv2.createTrackbar(</span><span class="s5">'cannyMin'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s3">, </span><span class="s1">self.cannyMin</span><span class="s3">, </span><span class="s4">255</span><span class="s3">, </span><span class="s1">nothing) 
        cv2.createTrackbar(</span><span class="s5">'cannyMax'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s3">, </span><span class="s1">self.cannyMax</span><span class="s3">, </span><span class="s4">255</span><span class="s3">, </span><span class="s1">nothing) 
        cv2.createTrackbar(</span><span class="s5">'threshMin'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s3">, </span><span class="s1">self.threshMin</span><span class="s3">, </span><span class="s4">255</span><span class="s3">, </span><span class="s1">nothing) 
        cv2.createTrackbar(</span><span class="s5">'threshMax'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s3">, </span><span class="s1">self.threshMax</span><span class="s3">, </span><span class="s4">255</span><span class="s3">, </span><span class="s1">nothing) 
        cv2.createTrackbar(</span><span class="s5">'minPixels'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s3">, </span><span class="s4">1000</span><span class="s3">, </span><span class="s4">5000</span><span class="s3">, </span><span class="s1">nothing) 
 
    </span><span class="s2"># Process frame and output the result</span><span class="s1"> 
    </span><span class="s2"># input:  string indicating what image to get</span><span class="s1"> 
    </span><span class="s2">#         image to invert if choice is &quot;inverted&quot;</span><span class="s1"> 
    </span><span class="s2">#</span><span class="s1"> 
    </span><span class="s2"># output: outputs Mat of your choice</span><span class="s1"> 
    </span><span class="s0">def </span><span class="s1">getFrame(self</span><span class="s3">, </span><span class="s1">choice</span><span class="s3">, </span><span class="s1">image=</span><span class="s0">None</span><span class="s3">, </span><span class="s1">min_thresh=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">max_thresh=</span><span class="s4">255</span><span class="s1">): 
        </span><span class="s0">if </span><span class="s1">choice </span><span class="s0">is </span><span class="s5">&quot;color&quot;</span><span class="s1">: 
            value = self.frame1 
            </span><span class="s0">return </span><span class="s1">value 
        </span><span class="s0">if </span><span class="s1">choice </span><span class="s0">is </span><span class="s5">&quot;grey_blurred&quot;</span><span class="s1">: 
            self.grey = cv2.cvtColor(self.frame1</span><span class="s3">, </span><span class="s1">cv2.COLOR_BGR2GRAY) 
            grey_blurred = cv2.blur(self.grey</span><span class="s3">, </span><span class="s1">(</span><span class="s4">3</span><span class="s3">,</span><span class="s4">3</span><span class="s1">)) 
            </span><span class="s0">return </span><span class="s1">grey_blurred 
        </span><span class="s0">if </span><span class="s1">choice </span><span class="s0">is </span><span class="s5">&quot;canny&quot;</span><span class="s1">: 
            canny = cv2.Canny(self.grey.copy()</span><span class="s3">, </span><span class="s1">self.cannyMin</span><span class="s3">, </span><span class="s1">self.cannyMax) 
            canny = cv2.dilate(canny</span><span class="s3">, </span><span class="s1">(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)) 
            </span><span class="s0">return </span><span class="s1">canny 
        </span><span class="s0">if </span><span class="s1">choice </span><span class="s0">is </span><span class="s5">&quot;inverted&quot;</span><span class="s1">: 
            cv2.bitwise_not(image</span><span class="s3">, </span><span class="s1">image) 
            </span><span class="s0">return </span><span class="s1">image 
        </span><span class="s0">if </span><span class="s1">choice </span><span class="s0">is </span><span class="s5">&quot;threshold&quot;</span><span class="s1">: 
            t_gray1 = cv2.cvtColor(self.frame1.copy()</span><span class="s3">, </span><span class="s1">cv2.COLOR_BGR2GRAY) 
            t_gray2 = cv2.cvtColor(self.frame2.copy()</span><span class="s3">, </span><span class="s1">cv2.COLOR_BGR2GRAY) 
            difference = cv2.absdiff(t_gray1</span><span class="s3">, </span><span class="s1">t_gray2) 
            ret</span><span class="s3">, </span><span class="s1">threshold = cv2.threshold(difference</span><span class="s3">, </span><span class="s1">self.threshMin</span><span class="s3">, </span><span class="s1">self.threshMax</span><span class="s3">, </span><span class="s1">cv2.THRESH_BINARY) 
            threshold = cv2.dilate(threshold</span><span class="s3">, </span><span class="s1">(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)) 
            </span><span class="s0">return </span><span class="s1">threshold 
 
    </span><span class="s2"># get current positions of trackbars</span><span class="s1"> 
    </span><span class="s0">def </span><span class="s1">process_trackbars(self): 
        self.cannyMin = cv2.getTrackbarPos(</span><span class="s5">'cannyMin'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s1">) 
        self.cannyMax = cv2.getTrackbarPos(</span><span class="s5">'cannyMax'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s1">) 
        self.threshMin = cv2.getTrackbarPos(</span><span class="s5">'threshMin'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s1">) 
        self.threshMax = cv2.getTrackbarPos(</span><span class="s5">'threshMax'</span><span class="s3">, </span><span class="s5">'image'</span><span class="s1">) 
 
    </span><span class="s2"># update frames</span><span class="s1"> 
    </span><span class="s0">def </span><span class="s1">tick(self): 
        self.frame4 = self.frame3 
        self.frame3 = self.frame2 
        self.frame2 = self.frame1 
        ret</span><span class="s3">, </span><span class="s1">self.frame1 = self.cap.read() 
        self.frame_count += </span><span class="s4">1</span><span class="s1"> 
        self.process_trackbars() 
 
 
</span><span class="s0">class </span><span class="s1">MyVideoWriter: 
    </span><span class="s0">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">camera_number</span><span class="s3">, </span><span class="s1">output_file): 
        self.out = </span><span class="s0">None</span><span class="s1"> 
        self.can_record = </span><span class="s0">False</span><span class="s1"> 
 
    </span><span class="s0">def </span><span class="s1">camera_intialize(self): 
        </span><span class="s0">if </span><span class="s1">self.can_record </span><span class="s0">is True</span><span class="s1">: 
            self.out = start_recording() 
 
    </span><span class="s2"># Read in number to use for new file name</span><span class="s1"> 
    </span><span class="s2"># Initialize recording</span><span class="s1"> 
    </span><span class="s2"># returns a file writing object</span><span class="s1"> 
    </span><span class="s0">def </span><span class="s1">start_recording(self): 
        myfile = open(</span><span class="s5">'output_count.txt'</span><span class="s3">, </span><span class="s5">'r+'</span><span class="s1">) 
        filecount = -</span><span class="s4">1</span><span class="s1"> 
        filecount = myfile.read() 
        myfile.close() 
        int_filecount = int(filecount) 
        </span><span class="s0">if </span><span class="s1">int_filecount </span><span class="s0">is </span><span class="s1">-</span><span class="s4">1</span><span class="s1">: 
            int_filecount = </span><span class="s4">0</span><span class="s1"> 
        fourcc = cv2.VideoWriter_fourcc(*</span><span class="s5">'XVID'</span><span class="s1">) 
        str_filecount = str(int_filecount) 
        filename = </span><span class="s5">'movement_#' </span><span class="s1">+ str_filecount 
        mytime = time.strftime(</span><span class="s5">&quot;  %d_%m_%Y&quot;</span><span class="s1">) 
        filename = filename + mytime + </span><span class="s5">'.avi'</span><span class="s1"> 
        out = cv2.VideoWriter(filename</span><span class="s3">, </span><span class="s1">fourcc</span><span class="s3">, </span><span class="s4">20.0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">640</span><span class="s3">, </span><span class="s4">480</span><span class="s1">)) 
        int_filecount = int_filecount + </span><span class="s4">1</span><span class="s1"> 
        myfile = open(</span><span class="s5">'output_count.txt'</span><span class="s3">, </span><span class="s5">'w'</span><span class="s1">) 
        str_filecount = str(int_filecount) 
        myfile.write(str_filecount) 
        myfile.close() 
        </span><span class="s0">return </span><span class="s1">out 
 
 
 
 
 
 
 
</span></pre>
</body>
</html>